# 專案 Code Review 報告

**專案名稱**: Coach Aaron 健身教練網站  
**審查日期**: 2026-01-13  
**審查者**: GitHub Copilot  
**時間戳記**: 2026-01-13T00:00:00Z (ISO 8601)

---

## 📊 專案概覽

### 技術棧

- **前端**: React + Vite + TailwindCSS
- **後端**: Express.js + Node.js
- **資料庫**: Supabase (PostgreSQL)
- **認證**: JWT + bcrypt
- **部署**: Vercel

### 專案架構

```
coach-aaron-test/
├── frontend/          # React SPA
├── backend/           # Express API Server
├── database/          # SQL Schema & Seed Data
├── scripts/           # 工具腳本
└── assets/            # 靜態資源
```

---

## ✅ 優點分析

### 1. **資料庫設計**

- ✅ 完整的 Schema 設計（9 張核心表）
- ✅ 使用 RLS (Row Level Security) 保護資料
- ✅ 建立適當的索引優化查詢效能
- ✅ 軟刪除機制 (`deleted_at`)
- ✅ 自動更新 `updated_at` 的 Trigger
- ✅ 外鍵約束確保資料完整性

### 2. **後端架構**

- ✅ 模組化設計（routes, controllers, middleware 分離）
- ✅ JWT 認證機制完善
- ✅ 管理員白名單系統
- ✅ CORS 配置正確
- ✅ 使用 Supabase Admin Client 繞過 RLS
- ✅ Cookie-based Token 儲存（HttpOnly, SameSite）

### 3. **前端設計**

- ✅ 現代化 UI 設計（無漸層、銳利風格）
- ✅ 完整的管理後台功能
- ✅ UI 組件庫抽象（可重用性高）
- ✅ Context API 管理全域狀態

### 4. **安全性**

- ✅ 密碼使用 bcrypt 加密（10 rounds）
- ✅ JWT Secret 環境變數化
- ✅ HttpOnly Cookie 防止 XSS
- ✅ RLS 政策保護資料存取
- ✅ 管理員白名單機制

---

## ⚠️ 發現的問題

### 🔴 嚴重問題

#### 1. **缺少資料庫 `password_hash` 欄位**

**位置**: [database/schema.sql](database/schema.sql#L8-L24)  
**問題**: `users` 表沒有定義 `password_hash` 欄位，但 [backend/routes/auth.js](backend/routes/auth.js#L42) 中有使用。

```sql
-- 現有 schema 缺少此欄位
CREATE TABLE IF NOT EXISTS public.users (
  user_id SERIAL PRIMARY KEY,
  -- ...其他欄位
  -- ❌ 缺少 password_hash VARCHAR(255)
);
```

**修復建議**:

```sql
ALTER TABLE public.users ADD COLUMN password_hash VARCHAR(255);
```

#### 2. **Supabase Config 缺少環境變數檢查**

**位置**: [backend/config/supabase.js](backend/config/supabase.js#L1-L12)  
**問題**: 沒有檢查環境變數是否存在就直接使用。

```javascript
// ❌ 當前程式碼
const supabaseUrl = process.env.SUPABASE_URL;
const supabaseAnonKey = process.env.SUPABASE_ANON_KEY;

// ✅ 建議改為
if (!supabaseUrl || !supabaseAnonKey || !supabaseServiceKey) {
  throw new Error("Missing Supabase environment variables");
}
```

#### 3. **JWT Secret 未檢查**

**位置**: [backend/routes/auth.js](backend/routes/auth.js#L73-L81)  
**問題**: 如果 `JWT_SECRET` 未設定，會導致 JWT 簽發失敗但沒有明確錯誤訊息。

---

### 🟡 中等問題

#### 4. **錯誤處理不一致**

**位置**: 多個 API 路由  
**問題**: 有些錯誤只有 `console.error`，有些有回傳詳細訊息，不一致。

**建議**: 建立統一的錯誤處理 Middleware。

```javascript
// middleware/errorHandler.js
const errorHandler = (err, req, res, next) => {
  console.error("Error:", err);

  const statusCode = err.statusCode || 500;
  const message =
    process.env.NODE_ENV === "production" ? "伺服器錯誤" : err.message;

  res.status(statusCode).json({
    error: message,
    ...(process.env.NODE_ENV !== "production" && { stack: err.stack }),
  });
};
```

#### 5. **缺少 Logging 機制**

**位置**: 整個後端  
**問題**: 僅使用 `console.log/error`，生產環境需要更完善的日誌系統。

**建議**: 使用 `winston` 或 `pino` 建立結構化日誌。

#### 6. **API 缺少 Rate Limiting**

**位置**: [backend/index.js](backend/index.js)  
**問題**: 沒有限流保護，容易遭受暴力攻擊。

**建議**: 使用 `express-rate-limit`。

```javascript
const rateLimit = require("express-rate-limit");

const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 分鐘
  max: 100, // 限制 100 次請求
});

app.use("/api/", limiter);
```

#### 7. **Vercel.json 設定問題**

**位置**: [vercel.json](vercel.json#L15-L17)  
**問題**:

- `frontend/$1` 路徑可能不正確（應該是 `frontend/dist/client/$1`）
- 環境變數使用 `@` 語法（Vercel Secret），但需要先在 Vercel 設定

---

### 🟢 輕微問題

#### 8. **缺少 API 版本控制**

當前所有 API 都是 `/api/*`，未來 API 變更時會有相容性問題。

**建議**: 使用 `/api/v1/*`。

#### 9. **缺少輸入驗證庫**

**位置**: 所有 POST/PUT 路由  
**問題**: 手動驗證欄位，容易遺漏。

**建議**: 使用 `joi` 或 `express-validator`。

```javascript
const { body, validationResult } = require("express-validator");

router.post(
  "/register",
  [
    body("email").isEmail(),
    body("username").isLength({ min: 3, max: 50 }),
    body("password").isLength({ min: 8 }),
  ],
  async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({ errors: errors.array() });
    }
    // ...
  }
);
```

#### 10. **前端 API 錯誤處理不足**

**位置**: `frontend/src/lib/api.js`  
**問題**: API 錯誤沒有統一處理機制。

#### 11. **缺少環境變數範例說明**

`.env.example` 檔案存在但沒有詳細註解。

#### 12. **Git 分支策略問題**

當前在 `master` 分支，但 remote 預設分支是 `main`，容易混淆。

---

## 🔧 必須修復的清單

### 高優先級 (P0)

1. ✅ 補充 `users.password_hash` 欄位到 schema
2. ✅ 加入環境變數檢查機制
3. ✅ 修正 Vercel.json 路徑設定
4. ✅ 建立完整的 README.md

### 中優先級 (P1)

5. ✅ 統一錯誤處理機制
6. ⚠️ 加入 Rate Limiting
7. ⚠️ 加入結構化 Logging
8. ⚠️ 加入輸入驗證

### 低優先級 (P2)

9. API 版本控制
10. 前端錯誤處理優化
11. 改善 .env.example 註解

---

## 📝 建議改進項目

### 1. 測試覆蓋率

目前沒有測試，建議加入：

- 單元測試（Jest）
- API 整合測試（Supertest）
- E2E 測試（Playwright）

### 2. CI/CD Pipeline

建議建立 GitHub Actions：

- 自動執行測試
- Lint 檢查
- 自動部署到 Vercel

### 3. 資料庫遷移管理

建議使用 `prisma` 或 `knex` 管理 Schema 版本。

### 4. 前端狀態管理

如果專案變大，考慮使用 `Zustand` 或 `Redux Toolkit`。

### 5. 效能優化

- 前端加入 React.lazy + Suspense
- API 加入快取機制（Redis）
- 圖片使用 CDN

### 6. 安全強化

- 加入 CSRF Token
- 實作 2FA 雙因素認證
- 密碼強度檢查
- 登入失敗次數限制

---

## 📁 檔案結構建議

### 當前問題

- ❌ 根目錄有 `.pptx` 等非程式碼檔案
- ❌ 缺少 `docs/` 資料夾
- ❌ 缺少 `tests/` 資料夾

### 建議結構

```
coach-aaron-test/
├── .github/
│   └── workflows/          # CI/CD
├── backend/
│   ├── src/
│   │   ├── config/
│   │   ├── controllers/    # 業務邏輯
│   │   ├── middleware/
│   │   ├── routes/
│   │   ├── services/       # 資料庫操作
│   │   ├── utils/          # 工具函數
│   │   └── validators/     # 輸入驗證
│   ├── tests/
│   └── index.js
├── frontend/
│   ├── src/
│   └── tests/
├── database/
│   ├── migrations/         # Schema 版本控制
│   ├── schema.sql
│   └── seed.sql
├── docs/                   # 文件
│   ├── API.md
│   ├── DEPLOYMENT.md
│   └── ARCHITECTURE.md
├── REPORTS/                # 審查報告（本報告所在）
└── README.md
```

---

## 🎯 程式碼品質評分

| 項目     | 分數 | 說明                               |
| -------- | ---- | ---------------------------------- |
| 架構設計 | 8/10 | 模組化良好，但可再細分 services 層 |
| 安全性   | 7/10 | 基本安全措施完善，但缺少進階防護   |
| 可維護性 | 7/10 | 程式碼清晰，但缺少註解和文件       |
| 可擴展性 | 8/10 | 架構支援擴展，但需加入版本控制     |
| 效能     | 6/10 | 未做優化，缺少快取和限流           |
| 測試覆蓋 | 0/10 | ❌ 完全沒有測試                    |

**總評**: 7/10  
專案架構良好，基礎功能完整，但缺少測試和進階安全防護。

---

## 🚀 後續步驟

### 立即執行

1. 修復資料庫 Schema (`password_hash` 欄位)
2. 加入環境變數檢查
3. 建立完整 README.md
4. 推送到 GitHub

### 本週內完成

5. 加入輸入驗證（express-validator）
6. 統一錯誤處理機制
7. 加入 Rate Limiting
8. 撰寫 API 文件

### 未來規劃

9. 建立測試框架
10. 設定 CI/CD
11. 效能優化
12. 安全強化

---

## 📞 聯絡資訊

如有問題請聯絡專案負責人。

---

**報告結束**
