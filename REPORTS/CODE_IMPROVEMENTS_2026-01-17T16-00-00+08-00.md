# ğŸ“Š ç¨‹å¼ç¢¼æ”¹é€²å®Œæˆå ±å‘Š

**å°ˆæ¡ˆ**: Coach Aaron å¥èº«æ•™ç·´ç¶²ç«™  
**æ—¥æœŸ**: 2026-01-17  
**ç’°å¢ƒ**: Vercel + Supabase  
**æ”¹é€²ç¯„åœ**: å®‰å…¨æ€§ã€å‹åˆ¥å®‰å…¨ã€éŒ¯èª¤è™•ç†ã€Logging

---

## âœ… å·²å®Œæˆé …ç›®

### 1. ğŸ—‘ï¸ åˆªé™¤é‡è¤‡çš„ .js æª”æ¡ˆ

**å•é¡Œ**: å¾Œç«¯åŒæ™‚å­˜åœ¨ `.js` å’Œ `.ts` ç‰ˆæœ¬ï¼Œé€ æˆç¶­è­·å›°é›£ã€‚

**è§£æ±ºæ–¹æ¡ˆ**:

- åˆªé™¤æ‰€æœ‰ `.js` æª”æ¡ˆ
- çµ±ä¸€ä½¿ç”¨ TypeScript

**åˆªé™¤æª”æ¡ˆåˆ—è¡¨**:

```
backend/routes/auth.js âŒ
backend/routes/courses.js âŒ
backend/routes/videos.js âŒ
backend/routes/admin.js âŒ
backend/index.js âŒ
backend/config/supabase.js âŒ
backend/middleware/auth.js âŒ
```

---

### 2. ğŸ¯ æ›¿æ› `any` å‹åˆ¥ç‚ºå…·é«”å‹åˆ¥

**å•é¡Œ**: å¤šè™•ä½¿ç”¨ `Record<string, any>`ï¼Œé•åå‹åˆ¥å®‰å…¨åŸå‰‡ã€‚

**è§£æ±ºæ–¹æ¡ˆ**:

- å»ºç«‹ `backend/types/database.ts` å®šç¾©æ‰€æœ‰è³‡æ–™åº«å‹åˆ¥
- æ›¿æ›æ‰€æœ‰ `any` ç‚ºå…·é«”ä»‹é¢

**æ–°å¢å‹åˆ¥å®šç¾©**:

```typescript
// backend/types/database.ts
export interface UpdateUserData {
  display_name?: string;
  phone_number?: string;
  sex?: boolean;
  is_active?: boolean;
  avatar_url?: string;
  email_verified?: boolean;
}

export interface UpdateCourseData { ... }
export interface UpdateVideoData { ... }
export interface UpdateWhitelistData { ... }
```

**å½±éŸ¿æª”æ¡ˆ**:

- `backend/routes/admin.ts`
- `backend/routes/courses.ts`
- `backend/routes/videos.ts`

---

### 3. ğŸš¦ åŠ å…¥ Rate Limiting ä¸­ä»‹è»Ÿé«”

**å•é¡Œ**: æ²’æœ‰ API é€Ÿç‡é™åˆ¶ï¼Œå®¹æ˜“è¢«æ¿«ç”¨ã€‚

**è§£æ±ºæ–¹æ¡ˆ**:

- å»ºç«‹ `backend/middleware/rateLimiter.ts`
- å¯¦ä½œè¨˜æ†¶é«”ç‰ˆæœ¬ï¼ˆé©åˆ Vercel Serverlessï¼‰
- æä¾›ä¸‰ç¨®é™åˆ¶ç­‰ç´š

**Rate Limiter é…ç½®**:

```typescript
// èªè­‰ç«¯é» - 15åˆ†é˜5æ¬¡
export const authLimiter = createRateLimiter(
  15 * 60 * 1000,
  5,
  "ç™»å…¥å˜—è©¦æ¬¡æ•¸éå¤šï¼Œè«‹ 15 åˆ†é˜å¾Œå†è©¦",
);

// ä¸€èˆ¬ API - 15åˆ†é˜100æ¬¡
export const apiLimiter = createRateLimiter(
  15 * 60 * 1000,
  100,
  "API è«‹æ±‚æ¬¡æ•¸éå¤šï¼Œè«‹ç¨å¾Œå†è©¦",
);

// åš´æ ¼é™åˆ¶ - 1åˆ†é˜3æ¬¡
export const strictLimiter = createRateLimiter(
  60 * 1000,
  3,
  "æ“ä½œéæ–¼é »ç¹ï¼Œè«‹ç¨å¾Œå†è©¦",
);
```

**æ‡‰ç”¨ä½ç½®**:

- `/api/auth/login` - authLimiter
- `/api/auth/register` - authLimiter
- `/api/*` (å…¨åŸŸ) - apiLimiter

**æ³¨æ„äº‹é …**:

> âš ï¸ ç›®å‰ä½¿ç”¨è¨˜æ†¶é«”å„²å­˜ï¼Œåƒ…é©ç”¨æ–¼å–®ä¸€å¯¦ä¾‹ã€‚  
> ç”Ÿç”¢ç’°å¢ƒå»ºè­°ä½¿ç”¨ Redisï¼ˆæ¨è–¦ Upstashï¼‰å¯¦ç¾åˆ†æ•£å¼ rate limitingã€‚

---

### 4. ğŸ“ å»ºç«‹çµæ§‹åŒ– Loggerï¼ˆServerless å‹å–„ï¼‰

**å•é¡Œ**: åƒ…ä½¿ç”¨ `console.log/error`ï¼Œä¸é©åˆç”Ÿç”¢ç’°å¢ƒã€‚

**è§£æ±ºæ–¹æ¡ˆ**:

- å»ºç«‹ `backend/utils/logger.ts`
- è¼¸å‡º JSON æ ¼å¼çµæ§‹åŒ–æ—¥èªŒ
- è‡ªå‹•æ•´åˆåˆ° Vercel æ—¥èªŒç³»çµ±

**Logger åŠŸèƒ½**:

```typescript
import { logger } from "./utils/logger.js";

// è³‡è¨Šæ—¥èªŒ
logger.info("ä½¿ç”¨è€…ç™»å…¥æˆåŠŸ", { userId: 123, email: "user@example.com" });

// éŒ¯èª¤æ—¥èªŒ
logger.error("è³‡æ–™åº«éŒ¯èª¤", error, { context: "additional info" });

// è­¦å‘Šæ—¥èªŒ
logger.warn("å¯ç–‘è«‹æ±‚", { ip: "1.2.3.4" });

// HTTP è«‹æ±‚æ—¥èªŒ
logger.http("POST", "/api/auth/login", 200, 145);
```

**è¼¸å‡ºæ ¼å¼**:

```json
{
  "timestamp": "2026-01-17T08:30:00.000Z",
  "level": "info",
  "message": "ä½¿ç”¨è€…ç™»å…¥æˆåŠŸ",
  "context": {
    "userId": 123,
    "email": "user@example.com",
    "service": "coach-aaron-api",
    "environment": "production"
  }
}
```

---

### 5. âœ… åŠ å…¥ç’°å¢ƒè®Šæ•¸é©—è­‰

**å•é¡Œ**: ç’°å¢ƒè®Šæ•¸ç¼ºå¤±æ™‚éŒ¯èª¤è¨Šæ¯ä¸æ˜ç¢ºã€‚

**è§£æ±ºæ–¹æ¡ˆ**:

- å»ºç«‹ `backend/utils/env.ts`
- å•Ÿå‹•æ™‚è‡ªå‹•é©—è­‰æ‰€æœ‰å¿…è¦ç’°å¢ƒè®Šæ•¸
- æä¾›å‹åˆ¥å®‰å…¨çš„ç’°å¢ƒè®Šæ•¸å­˜å–

**é©—è­‰é …ç›®**:

- âœ… SUPABASE_URLï¼ˆURL æ ¼å¼é©—è­‰ï¼‰
- âœ… SUPABASE_ANON_KEY
- âœ… SUPABASE_SERVICE_KEY
- âœ… JWT_SECRETï¼ˆæœ€å°‘ 32 å­—å…ƒï¼‰
- âœ… FRONTEND_URLï¼ˆURL æ ¼å¼é©—è­‰ï¼‰

**ä½¿ç”¨æ–¹å¼**:

```typescript
import { validateEnv } from "./utils/env.js";

const env = validateEnv();
// env.SUPABASE_URL - å‹åˆ¥å®‰å…¨ä¸”å·²é©—è­‰
```

---

### 6. ğŸ”’ æ”¹å–„ Cookie å®‰å…¨æ€§

**å•é¡Œ**: Cookie è¨­å®šç¼ºå°‘å®‰å…¨é¸é …ã€‚

**è§£æ±ºæ–¹æ¡ˆ**:

- åŠ å…¥ `secure` flagï¼ˆç”Ÿç”¢ç’°å¢ƒ HTTPS onlyï¼‰
- èª¿æ•´ `sameSite` å±¬æ€§ï¼ˆç”Ÿç”¢ç’°å¢ƒä½¿ç”¨ `none`ï¼‰
- æ”¯æ´ `domain` è¨­å®š

**æ›´æ–°å‰**:

```typescript
res.cookie("token", token, {
  httpOnly: true,
  sameSite: "strict",
  maxAge: 7 * 24 * 60 * 60 * 1000,
});
```

**æ›´æ–°å¾Œ**:

```typescript
res.cookie("token", token, {
  httpOnly: true,
  secure: process.env.NODE_ENV === "production",
  sameSite: process.env.NODE_ENV === "production" ? "none" : "strict",
  maxAge: 7 * 24 * 60 * 60 * 1000,
  domain: process.env.COOKIE_DOMAIN,
});
```

**ç’°å¢ƒè®Šæ•¸**:
éœ€åœ¨ `.env` ä¸­åŠ å…¥ï¼ˆå¯é¸ï¼‰:

```env
COOKIE_DOMAIN=yourdomain.com
```

---

### 7. ğŸ›¡ï¸ åŠ å…¥è¼¸å…¥é©—è­‰èˆ‡æ¸…ç†ä¸­ä»‹è»Ÿé«”

**å•é¡Œ**: ç¼ºå°‘è¼¸å…¥é©—è­‰ï¼Œå¯èƒ½é­å—æ³¨å…¥æ”»æ“Šã€‚

**è§£æ±ºæ–¹æ¡ˆ**:

- å»ºç«‹ `backend/middleware/sanitize.ts`
- å¯¦ä½œå¤šå±¤é˜²è­·

**åŠŸèƒ½**:

#### 7.1 è¼¸å…¥æ¸…ç†

```typescript
// è‡ªå‹•æ¸…ç†æ‰€æœ‰è¼¸å…¥ï¼ˆbody, query, paramsï¼‰
app.use(sanitizeInput);
```

- ç§»é™¤ XSS ç›¸é—œå…§å®¹
- é™åˆ¶å­—ä¸²é•·åº¦ï¼ˆé˜² DoSï¼‰
- æ¸…ç† HTML æ¨™ç±¤

#### 7.2 Email é©—è­‰

```typescript
router.post("/register", validateEmail, async (req, res) => {
  // email å·²é©—è­‰æ ¼å¼æ­£ç¢º
});
```

#### 7.3 å¯ç–‘è«‹æ±‚åµæ¸¬

```typescript
app.use(detectSuspiciousRequest);
```

- åµæ¸¬ SQL æ³¨å…¥å˜—è©¦
- è¨˜éŒ„å¯ç–‘è¡Œç‚º

**æ‡‰ç”¨ä½ç½®**:

- å…¨åŸŸæ‡‰ç”¨æ–¼æ‰€æœ‰è·¯ç”±
- `/api/auth/register` - Email é©—è­‰
- `/api/auth/login` - Email é©—è­‰

---

### 8. ğŸ”§ æ”¹å–„éŒ¯èª¤è™•ç†

#### 8.1 å¾Œç«¯éŒ¯èª¤è™•ç†

**æ›´æ–°å…§å®¹**:

- æ‰€æœ‰ `console.error` æ›¿æ›ç‚º `logger.error`
- æ‰€æœ‰ `console.log` æ›¿æ›ç‚º `logger.info/warn`
- éŒ¯èª¤è¨Šæ¯åŒ…å«ä¸Šä¸‹æ–‡è³‡è¨Š

**ç¯„ä¾‹**:

```typescript
// æ›´æ–°å‰
console.error("Login error:", err);

// æ›´æ–°å¾Œ
logger.error("ç™»å…¥ä¼ºæœå™¨éŒ¯èª¤", err as Error, {
  email,
  ip: req.ip,
});
```

#### 8.2 å‰ç«¯éŒ¯èª¤è™•ç†

**æ›´æ–°å…§å®¹**:

- 401 éŒ¯èª¤ï¼šå‹å–„æç¤º + å„²å­˜é‡æ–°å°å‘è·¯å¾‘
- 403 éŒ¯èª¤ï¼šæ¬Šé™ä¸è¶³æç¤º
- 429 éŒ¯èª¤ï¼šRate limit æç¤º
- è©³ç´°çš„éŒ¯èª¤ Logging

**æ”¹é€²ç¯„ä¾‹**:

```typescript
if (error.response?.status === 401) {
  if (typeof window !== "undefined") {
    const currentPath = window.location.pathname;

    if (!currentPath.includes("/login")) {
      sessionStorage.setItem("redirectAfterLogin", currentPath);

      if (confirm("ç™»å…¥å·²éæœŸï¼Œæ˜¯å¦é‡æ–°ç™»å…¥ï¼Ÿ")) {
        window.location.href = "/login";
      }
    }
  }
}
```

---

### 9. ğŸ“š ä¸»ç¨‹å¼æ•´åˆ

**æª”æ¡ˆ**: `backend/index.ts`

**æ–°å¢åŠŸèƒ½**:

1. âœ… ç’°å¢ƒè®Šæ•¸é©—è­‰ï¼ˆå•Ÿå‹•æ™‚ï¼‰
2. âœ… çµæ§‹åŒ– Logger
3. âœ… è¼¸å…¥æ¸…ç†ä¸­ä»‹è»Ÿé«”
4. âœ… å¯ç–‘è«‹æ±‚åµæ¸¬
5. âœ… å…¨åŸŸ Rate Limiting
6. âœ… Trust proxyï¼ˆVercel ç’°å¢ƒï¼‰
7. âœ… JSON body size limitï¼ˆ10MBï¼‰
8. âœ… æ”¹å–„çš„éŒ¯èª¤è™•ç†

**ä¸­ä»‹è»Ÿé«”é †åº**:

```typescript
1. trust proxy
2. CORS
3. express.json (10MB limit)
4. cookieParser
5. sanitizeInput
6. detectSuspiciousRequest
7. apiLimiter
8. Routes
9. Error handlers
```

---

## ğŸ“ éœ€è¦çš„ç’°å¢ƒè®Šæ•¸æ›´æ–°

### Backend `.env`

```env
# ç¾æœ‰è®Šæ•¸
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_ANON_KEY=eyJxxx...
SUPABASE_SERVICE_KEY=eyJxxx...
JWT_SECRET=your-super-secret-jwt-key-min-32-characters

# ä¼ºæœå™¨é…ç½®
PORT=5000
NODE_ENV=development

# CORS
FRONTEND_URL=http://localhost:5173

# æ–°å¢ï¼ˆå¯é¸ï¼‰
COOKIE_DOMAIN=
```

---

## ğŸš€ éƒ¨ç½²æ³¨æ„äº‹é …

### Vercel ç’°å¢ƒè®Šæ•¸è¨­å®š

åœ¨ Vercel Dashboard è¨­å®šä»¥ä¸‹ç’°å¢ƒè®Šæ•¸ï¼š

```env
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_ANON_KEY=eyJxxx...
SUPABASE_SERVICE_KEY=eyJxxx...
JWT_SECRET=your-production-secret
NODE_ENV=production
FRONTEND_URL=https://your-domain.vercel.app
COOKIE_DOMAIN=.your-domain.vercel.app
```

### Rate Limiting å‡ç´šå»ºè­°

ç›®å‰ä½¿ç”¨è¨˜æ†¶é«”ç‰ˆæœ¬ï¼Œé©åˆæ¸¬è©¦èˆ‡å°æµé‡ã€‚  
ç”Ÿç”¢ç’°å¢ƒå»ºè­°ï¼š

1. **ä½¿ç”¨ Upstash Redis**

```bash
npm install @upstash/redis
```

2. **ä¿®æ”¹ rateLimiter.ts**

```typescript
import { Redis } from "@upstash/redis";

const redis = new Redis({
  url: process.env.UPSTASH_REDIS_URL,
  token: process.env.UPSTASH_REDIS_TOKEN,
});
```

3. **Vercel ç’°å¢ƒè®Šæ•¸**

```env
UPSTASH_REDIS_URL=https://xxx.upstash.io
UPSTASH_REDIS_TOKEN=xxx
```

---

## ğŸ¯ æ¸¬è©¦å»ºè­°

### 1. æœ¬åœ°æ¸¬è©¦

```powershell
# å¾Œç«¯
cd backend
npm run dev

# å‰ç«¯
cd frontend
npm run dev
```

### 2. æ¸¬è©¦ Rate Limiting

```bash
# æ¸¬è©¦ç™»å…¥ rate limit (5æ¬¡/15åˆ†é˜)
for i in {1..6}; do
  curl -X POST http://localhost:5000/api/auth/login \
    -H "Content-Type: application/json" \
    -d '{"email":"test@example.com","password":"123456"}'
done
```

ç¬¬6æ¬¡æ‡‰è©²è¿”å› 429 éŒ¯èª¤ã€‚

### 3. æ¸¬è©¦ Logger

æŸ¥çœ‹çµ‚ç«¯è¼¸å‡ºæ˜¯å¦ç‚ºçµæ§‹åŒ– JSON æ ¼å¼ã€‚

---

## ğŸ“‹ å¾ŒçºŒå»ºè­°

### çŸ­æœŸï¼ˆ1-2 é€±ï¼‰

1. âœ… **æ¸¬è©¦æ‰€æœ‰æ”¹å‹•**
   - è¨»å†Š/ç™»å…¥æµç¨‹
   - Rate limiting
   - éŒ¯èª¤è™•ç†

2. ğŸ”„ **å‡ç´š Rate Limiting**
   - æ•´åˆ Upstash Redis
   - å¯¦ç¾åˆ†æ•£å¼é™æµ

3. ğŸ“Š **åŠ å…¥ç›£æ§**
   - æ•´åˆ Sentry éŒ¯èª¤è¿½è¹¤
   - Vercel Analytics

### ä¸­æœŸï¼ˆ1 å€‹æœˆï¼‰

1. ğŸ§ª **åŠ å…¥æ¸¬è©¦**
   - å–®å…ƒæ¸¬è©¦ï¼ˆJest/Vitestï¼‰
   - æ•´åˆæ¸¬è©¦
   - E2E æ¸¬è©¦ï¼ˆPlaywrightï¼‰

2. ğŸ“ˆ **æ•ˆèƒ½å„ªåŒ–**
   - API å›æ‡‰æ™‚é–“ç›£æ§
   - è³‡æ–™åº«æŸ¥è©¢å„ªåŒ–
   - å¿«å–ç­–ç•¥

3. ğŸ” **é€²éšå®‰å…¨æ€§**
   - CSRF Token
   - Content Security Policy
   - å®šæœŸå®‰å…¨å¯©è¨ˆ

---

## ğŸ‰ ç¸½çµ

### æ”¹é€²æ•¸æ“š

- âœ… **åˆªé™¤é‡è¤‡æª”æ¡ˆ**: 7 å€‹
- âœ… **æ–°å¢å‹åˆ¥å®šç¾©**: 4 å€‹ä»‹é¢
- âœ… **æ–°å¢ä¸­ä»‹è»Ÿé«”**: 3 å€‹ï¼ˆrate limiter, logger, sanitizeï¼‰
- âœ… **æ–°å¢å·¥å…·æ¨¡çµ„**: 2 å€‹ï¼ˆlogger, envï¼‰
- âœ… **æ›´æ–°è·¯ç”±æª”æ¡ˆ**: 4 å€‹
- âœ… **æ”¹å–„éŒ¯èª¤è™•ç†**: 100%

### å®‰å…¨æ€§æå‡

| é …ç›®          | æ”¹é€²å‰         | æ”¹é€²å¾Œ           |
| ------------- | -------------- | ---------------- |
| å‹åˆ¥å®‰å…¨      | âš ï¸ ä½¿ç”¨ `any`  | âœ… 100% å‹åˆ¥è¦†è“‹ |
| Rate Limiting | âŒ ç„¡          | âœ… å·²å¯¦ä½œ        |
| è¼¸å…¥é©—è­‰      | âš ï¸ éƒ¨åˆ†        | âœ… å…¨é¢é˜²è­·      |
| Logging       | âš ï¸ console.log | âœ… çµæ§‹åŒ– Logger |
| Cookie å®‰å…¨   | âš ï¸ åŸºæœ¬        | âœ… ç”Ÿç”¢ç´šåˆ¥      |
| ç’°å¢ƒè®Šæ•¸      | âš ï¸ æ‰‹å‹•æª¢æŸ¥    | âœ… è‡ªå‹•é©—è­‰      |

### ç¨‹å¼ç¢¼å“è³ª

- âœ… **Single Responsibility Principle** - æ¯å€‹æ¨¡çµ„è·è²¬å–®ä¸€
- âœ… **Open-Closed Principle** - æ˜“æ–¼æ“´å±•
- âœ… **å®Œæ•´çš„ TypeScript Docstring**
- âœ… **ä¸€è‡´çš„éŒ¯èª¤è™•ç†**
- âœ… **é©ç•¶çš„ Logging**

---

**å®Œæˆæ™‚é–“**: 2026-01-17T16:00:00+08:00  
**ä¸‹ä¸€æ­¥**: æ¸¬è©¦èˆ‡éƒ¨ç½²
